<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Margins</title>

  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.json">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%; overflow-y: auto;
      background: #f4f4f4;
      font-family: "Poppins", sans-serif;
      display: flex; align-items: center; justify-content: center;
      padding: 2vw;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.10);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }
    .logo img {
      max-width: 170px;
      height: auto;
      display: block;
    }

    .field { display: flex; flex-direction: column; gap: 4px; }
    label { font-weight: 600; text-align: left; font-size: 14px; }

    .row { display: flex; gap: 12px; }
    .row .field { flex: 1; min-width: 160px; }

    .input-group {
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }
    .input-group span {
      background: #eee;
      padding: 10px;
      font-size: 14px;
      border-right: 1px solid #ccc;
      font-weight: 600;
      white-space: nowrap;
    }
    .input-group input {
      width: 100%;
      padding: 10px;
      border: none;
      font-size: 14px;
      text-align: left;
      font-weight: 700;
      outline: none;
      background: #fff;
    }
    .input-group input[readonly] {
      background: #fafafa;
      color: #222;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; appearance: textfield; }

    .divider {
      height: 1px;
      background: #eee;
      margin: 4px 0;
    }

    button {
      padding: 12px 14px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 10px;
      width: 100%;
      margin-top: 8px;
      font-weight: 800;
    }
    button:hover { background: #222; }

    .hint {
      font-size: 12px;
      color: #666;
      margin-top: -2px;
    }

    @media only screen and (max-width: 768px) {
      .row { flex-direction: column; gap: 8px; }
      body { padding-top: 8vh; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- LOGO -->
    <div class="logo">
      <img src="logo.png" alt="Logo" />
    </div>

    <!-- Purchase Price -->
    <label>Purchase Price</label>
    <div class="row">
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="purchasePrice" min="0" inputmode="decimal" />
          <span>Excl.</span>
        </div>
      </div>
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="purchasePriceIncl" min="0" inputmode="decimal" />
          <span>Incl.</span>
        </div>
      </div>
    </div>

    <!-- Selling Price -->
    <label>Selling Price</label>
    <div class="row">
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="sellPrice" min="0" inputmode="decimal" />
          <span>Incl.</span>
        </div>
      </div>
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="netPrice" min="0" inputmode="decimal" />
          <span>Excl.</span>
        </div>
      </div>
    </div>

    <!-- Margin (normal) -->
    <label>Margin</label>
    <div class="row">
      <div class="field">
        <div class="input-group">
          <span>%</span>
          <input type="number" id="profitMargin" min="0" max="99" inputmode="decimal" />
        </div>
      </div>
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="profitAmount" min="0" inputmode="decimal" />
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Discount -->
    <label>Discount</label>
    <div class="row">
      <div class="field">
        <div class="input-group">
          <span>%</span>
          <input type="number" id="discountPercentage" min="0" max="99" inputmode="decimal" />
        </div>
      </div>
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="discountAmount" min="0" inputmode="decimal" />
        </div>
      </div>
    </div>

    <label>New Price</label>
    <div class="field">
      <div class="input-group">
        <span>€</span>
        <input type="number" id="newPrice" min="0" inputmode="decimal" />
        <span>Incl.</span>
      </div>
      <div class="hint">Typ in één van de discount velden. Leegmaken = marge terug naar normaal.</div>
    </div>

    <!-- Margin after discount -->
    <label>Margin after discount</label>
    <div class="row">
      <div class="field">
        <div class="input-group">
          <span>%</span>
          <input type="number" id="profitMarginDiscount" readonly />
        </div>
      </div>
      <div class="field">
        <div class="input-group">
          <span>€</span>
          <input type="number" id="profitAmountDiscount" readonly />
        </div>
      </div>
    </div>

    <!-- Button shows discounted margin live (text updated by JS) -->
    <button type="button" id="applyDiscount">Discount</button>
  </div>

  <script>
    const VAT = 1.21;

    const el = (id) => document.getElementById(id);

    function roundDown(value) {
      return isNaN(value) ? "" : Math.floor(value);
    }

    function num(id) {
      const v = parseFloat(el(id).value);
      return Number.isFinite(v) ? v : null;
    }

    function setVal(id, value) {
      el(id).value = (value === null || value === "" || Number.isNaN(value)) ? "" : roundDown(value);
    }

    let updating = false;
    let lastEdited = null;

    function discountActive() {
      return el("discountPercentage").value.trim() !== "" ||
             el("discountAmount").value.trim() !== "" ||
             el("newPrice").value.trim() !== "";
    }

    function clearDiscountFields(except = null) {
      if (except !== "discountPercentage") el("discountPercentage").value = "";
      if (except !== "discountAmount") el("discountAmount").value = "";
      if (except !== "newPrice") el("newPrice").value = "";
    }

    function effectiveSellIncl(sellIncl) {
      if (!discountActive()) return sellIncl;

      const newIncl = num("newPrice");
      if (newIncl !== null) return newIncl;

      const pct = num("discountPercentage");
      if (pct !== null && sellIncl !== null) return sellIncl * (1 - pct / 100);

      const amt = num("discountAmount");
      if (amt !== null && sellIncl !== null) return sellIncl - amt;

      return sellIncl;
    }

    function updateButton(marginPct, profitEur) {
      const btn = el("applyDiscount");
      if (!btn) return;

      if (marginPct === null || profitEur === null) {
        btn.textContent = "Discount";
        return;
      }
      btn.textContent = `Discount (marge: ${roundDown(marginPct)}% / €${roundDown(profitEur)})`;
    }

    function recalc() {
      if (updating) return;
      updating = true;

      // --- base values ---
      let purchaseEx = num("purchasePrice");
      let purchaseIn = num("purchasePriceIncl");

      let sellIn = num("sellPrice");
      let netEx = num("netPrice");

      let marginPct = num("profitMargin");
      let profitEur = num("profitAmount");

      // 1) Purchase sync
      if (lastEdited === "purchasePriceIncl" && purchaseIn !== null) {
        purchaseEx = purchaseIn / VAT;
        setVal("purchasePrice", purchaseEx);
      } else if (lastEdited === "purchasePrice" && purchaseEx !== null) {
        purchaseIn = purchaseEx * VAT;
        setVal("purchasePriceIncl", purchaseIn);
      } else {
        if (purchaseEx === null && purchaseIn !== null) {
          purchaseEx = purchaseIn / VAT;
          setVal("purchasePrice", purchaseEx);
        }
        if (purchaseIn === null && purchaseEx !== null) {
          purchaseIn = purchaseEx * VAT;
          setVal("purchasePriceIncl", purchaseIn);
        }
      }

      // 2) Selling sync
      if (lastEdited === "netPrice" && netEx !== null) {
        sellIn = netEx * VAT;
        setVal("sellPrice", sellIn);
      } else if (lastEdited === "sellPrice" && sellIn !== null) {
        netEx = sellIn / VAT;
        setVal("netPrice", netEx);
      } else {
        if (sellIn === null && netEx !== null) {
          sellIn = netEx * VAT;
          setVal("sellPrice", sellIn);
        }
        if (netEx === null && sellIn !== null) {
          netEx = sellIn / VAT;
          setVal("netPrice", netEx);
        }
      }

      // 3) Profit fields can drive selling price (all editable)
      if (purchaseEx !== null) {
        if (lastEdited === "profitMargin" && marginPct !== null) {
          const m = Math.min(Math.max(marginPct, 0), 99) / 100;
          const net = purchaseEx / (1 - m);
          netEx = net;
          sellIn = net * VAT;
          profitEur = net - purchaseEx;

          setVal("netPrice", netEx);
          setVal("sellPrice", sellIn);
          setVal("profitAmount", profitEur);
        }

        if (lastEdited === "profitAmount" && profitEur !== null) {
          const net = purchaseEx + profitEur;
          netEx = net;
          sellIn = net * VAT;
          marginPct = net > 0 ? (profitEur / net) * 100 : 0;

          setVal("netPrice", netEx);
          setVal("sellPrice", sellIn);
          setVal("profitMargin", marginPct);
        }
      }

      // 4) Normal margin (on base netEx)
      if (purchaseEx !== null && netEx !== null && netEx > 0) {
        const profit = netEx - purchaseEx;
        const m = (profit / netEx) * 100;

        // Only overwrite margin inputs if user isn't currently editing them
        if (lastEdited !== "profitAmount") setVal("profitAmount", profit);
        if (lastEdited !== "profitMargin") setVal("profitMargin", Math.min(m, 99));
      }

      // 5) Discount calcs (source is lastEdited among discount fields)
      if (!discountActive()) {
        // discount cleared => reset "after discount" fields + button
        el("profitMarginDiscount").value = "";
        el("profitAmountDiscount").value = "";
        updateButton(null, null);
        updating = false;
        return;
      }

      if (sellIn !== null) {
        if (lastEdited === "discountPercentage") {
          const pct = num("discountPercentage");
          if (pct !== null) {
            const newIncl = sellIn * (1 - pct / 100);
            setVal("newPrice", newIncl);
            setVal("discountAmount", sellIn - newIncl);
          }
        }

        if (lastEdited === "discountAmount") {
          const amt = num("discountAmount");
          if (amt !== null) {
            const newIncl = sellIn - amt;
            setVal("newPrice", newIncl);
            const pct = sellIn > 0 ? (amt / sellIn) * 100 : 0;
            setVal("discountPercentage", pct);
          }
        }

        if (lastEdited === "newPrice") {
          const newIncl = num("newPrice");
          if (newIncl !== null) {
            const amt = sellIn - newIncl;
            const pct = sellIn > 0 ? (amt / sellIn) * 100 : 0;
            setVal("discountAmount", amt);
            setVal("discountPercentage", pct);
          }
        }
      }

      // 6) Margin after discount (effective price)
      const effIncl = effectiveSellIncl(sellIn);
      const effNet = effIncl !== null ? (effIncl / VAT) : null;

      if (purchaseEx !== null && effNet !== null && effNet > 0) {
        const profitD = effNet - purchaseEx;
        const marginD = (profitD / effNet) * 100;

        setVal("profitAmountDiscount", profitD);
        setVal("profitMarginDiscount", Math.min(marginD, 99));

        updateButton(Math.min(marginD, 99), profitD);
      } else {
        el("profitMarginDiscount").value = "";
        el("profitAmountDiscount").value = "";
        updateButton(null, null);
      }

      updating = false;
    }

    function bind(id) {
      const input = el(id);
      if (!input) return;
      input.addEventListener("input", () => {
        lastEdited = id;

        // Veiligste keuze in winkel: als basisprijs wijzigt, reset korting
        // (voorkomt dat oude korting per ongeluk blijft hangen op een nieuwe sellPrice)
        if (id === "sellPrice" || id === "netPrice" || id === "purchasePrice" || id === "purchasePriceIncl") {
          clearDiscountFields(); // comment deze regel uit als je korting wilt laten staan
        }

        recalc();
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      [
        "purchasePrice","purchasePriceIncl",
        "sellPrice","netPrice",
        "profitMargin","profitAmount",
        "discountPercentage","discountAmount","newPrice"
      ].forEach(bind);

      // Button: copy discounted price -> selling price (bewuste actie)
      const btn = el("applyDiscount");
      btn.addEventListener("click", () => {
        const baseSell = num("sellPrice");
        if (baseSell === null) return;

        const eff = effectiveSellIncl(baseSell);
        if (eff !== null) {
          el("sellPrice").value = roundDown(eff);
          lastEdited = "sellPrice";
          clearDiscountFields();
          recalc();
        }
      });

      recalc();
    });
  </script>
</body>
</html>
